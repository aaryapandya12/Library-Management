<div class="card mt-4">
  <div class="card-header bg-#333 text-black">
    <h4 class="mb-0"><i class="bi bi-book me-2"></i>Books Issued</h4>
  </div>
  <div class="card-body">
    <div class="d-flex justify-content-between mb-4">
      <div>
        <select
          id="statusFilter"
          class="form-select shadow-sm"
          style="width: 200px"
        >
          <option value="all">All Status</option>
          <option value="pending">Pending</option>
          <option value="borrowed">Borrowed</option>
          <option value="returned">Returned</option>
        </select>
      </div>

      <div class="input-group" style="width: 300px">
        <span class="input-group-text bg-light"
          ><i class="bi bi-search"></i
        ></span>
        <input
          type="text"
          id="searchInput"
          class="form-control shadow-sm"
          placeholder="Search books..."
        />
      </div>
    </div>

    <div class="table-responsive rounded-3 border">
      <table class="table table-striped table-hover mb-0">
        <thead class="table-dark">
          <tr>
            <th class="ps-4">Record ID</th>
            <th>Book Title</th>
            <th>Borrower</th>
            <th>Borrow Date</th>
            <th>Due Date</th>
            <th>Status</th>
            <th class="pe-4 text-end">Actions</th>
          </tr>
        </thead>
        <tbody id="issuedBooksTableBody" class="border-top-0"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const borrowRecordsApiUrl = "http://localhost:8080/api/borrowRecords";
  const booksApiUrl = "http://localhost:8080/api/books";
  const usersApiUrl = "http://localhost:8080/api/users";

  let allRecords = [];
  let sortDirection = 1;
  let currentSortColumn = null;

  const statusFilter = document.getElementById("statusFilter");
  const searchInput = document.getElementById("searchInput");
  const issuedBooksTableBody = document.getElementById("issuedBooksTableBody");

  Promise.all([fetchBorrowRecords(), fetchBooks(), fetchUsers()]).then(() => {
    renderIssuedBooks();
    setupEventListeners();
  });

  function fetchBorrowRecords() {
    return fetch(borrowRecordsApiUrl)
      .then((res) => {
        if (!res.ok) throw new Error("Failed to fetch borrow records");
        return res.json();
      })
      .then((data) => {
        allRecords = Array.isArray(data) ? data : [];
      })
      .catch((error) => {
        console.error("Error fetching borrow records:", error);
        showAlert("Failed to load borrow records. Please try again.", "danger");
      });
  }

  function fetchBooks() {
    return fetch(booksApiUrl)
      .then((res) => {
        if (!res.ok) throw new Error("Failed to fetch books");
        return res.json();
      })
      .then((data) => {
        window.booksData = Array.isArray(data) ? data : [];
      })
      .catch((error) => {
        console.error("Error fetching books:", error);
      });
  }

  function fetchUsers() {
    return fetch(usersApiUrl)
      .then((res) => {
        if (!res.ok) throw new Error("Failed to fetch users");
        return res.json();
      })
      .then((data) => {
        window.usersData = Array.isArray(data) ? data : [];
      })
      .catch((error) => {
        console.error("Error fetching users:", error);
      });
  }

  function setupEventListeners() {
    statusFilter.addEventListener("change", renderIssuedBooks);
    searchInput.addEventListener("input", renderIssuedBooks);

    document.querySelectorAll("th[data-sortable]").forEach((header) => {
      header.addEventListener("click", () => {
        const column = header.getAttribute("data-sortable");
        if (currentSortColumn === column) {
          sortDirection *= -1;
        } else {
          currentSortColumn = column;
          sortDirection = 1;
        }
        renderIssuedBooks();
      });
    });
  }

function getBookTitle(bookId) {
  if (!window.booksData) return "Unknown Book";
  const book = window.booksData.find(
    (b) => b.bookID == bookId || b.id == bookId
  );
  return book ? (book.title || book.Title || "Unknown Book") : "Unknown Book";
}

  function getUserName(userId) {
  if (!window.usersData) return "Unknown User";
  const user = window.usersData.find(
    (u) => u.userID == userId || u.id == userId
  );
  return user ? (user.name || "Unknown User") : "Unknown User";
}

  function renderIssuedBooks() {
    const statusFilterValue = statusFilter.value;
    const searchTerm = searchInput.value.toLowerCase();

    let filteredRecords = allRecords.filter((record) => {
      const recordStatus = record.status ? record.status.toLowerCase() : "";
      const matchesStatus =
        statusFilterValue === "all" ||
        recordStatus === statusFilterValue.toLowerCase();

      const bookTitle = getBookTitle(record.bookID).toLowerCase();
      const userName = getUserName(record.userID).toLowerCase();

      const matchesSearch =
        bookTitle.includes(searchTerm) ||
        userName.includes(searchTerm) ||
        (record.recordID && record.recordID.toString().includes(searchTerm));

      return matchesStatus && matchesSearch;
    });

    if (currentSortColumn) {
      filteredRecords.sort((a, b) => {
        let aValue, bValue;

        switch (currentSortColumn) {
          case "title":
            aValue = getBookTitle(a.bookID);
            bValue = getBookTitle(b.bookID);
            return aValue.localeCompare(bValue) * sortDirection;
          case "borrower":
            aValue = getUserName(a.userID);
            bValue = getUserName(b.userID);
            return aValue.localeCompare(bValue) * sortDirection;
          case "borrowDate":
            return (
              (new Date(a.borrowDate) - new Date(b.borrowDate)) * sortDirection
            );
          case "dueDate":
            return (new Date(a.dueDate) - new Date(b.dueDate)) * sortDirection;
          case "status":
            return a.status.localeCompare(b.status) * sortDirection;
          default:
            return 0;
        }
      });
    }

    issuedBooksTableBody.innerHTML = filteredRecords
      .map(
        (record) => `
      <tr>
        <td class="ps-4">${record.recordID}</td>
        <td>${getBookTitle(record.bookID)}</td>
        <td>${getUserName(record.userID)}</td>
        <td>${formatDate(record.borrowDate)}</td>
        <td>${formatDate(record.dueDate)}</td>
        <td>
          <span class="badge ${
            record.status === "returned"
              ? "bg-success"
              : record.status === "borrowed"
              ? "bg-warning text-dark"
              : "bg-danger text-white"
          }">
            ${record.status}
          </span>
        </td>
        <td class="pe-4 text-end">
          ${
            record.status === "borrowed"
              ? `
            <button class="btn btn-sm btn-outline-success me-2 return-btn" data-id="${record.recordID}">
              <i class="bi bi-check-circle me-1"></i>Mark Returned
            </button>
          `
              : ""
          }
          <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${
            record.recordID
          }">
            <i class="bi bi-trash me-1"></i>Delete
          </button>
        </td>
      </tr>
    `
      )
      .join("");

    document.querySelectorAll(".return-btn").forEach((btn) => {
      btn.addEventListener("click", () => markAsReturned(btn.dataset.id));
    });

    document.querySelectorAll(".delete-btn").forEach((btn) => {
      btn.addEventListener("click", () => deleteRecord(btn.dataset.id));
    });
  }

  function formatDate(dateString) {
    if (!dateString) return "N/A";
    const date = new Date(dateString);
    return date.toLocaleDateString("en-US", {
      year: "numeric",
      month: "short",
      day: "numeric",
    });
  }
function markAsReturned(recordId) {
  if (confirm("Are you sure you want to mark this book as returned?")) {
    const record = allRecords.find((r) => r.recordID == recordId);
    if (!record) return;

    fetch(`${borrowRecordsApiUrl}/${recordId}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        Status: "returned",
        ReturnDate: new Date().toISOString().split("T")[0],
      }),
    })
      .then((res) => {
        if (!res.ok) throw new Error("Update failed");
        return fetchBorrowRecords();
      })
      .then(() => {
        renderIssuedBooks();
        showAlert("Book marked as returned successfully", "success");

        const book = window.booksData.find(
          (b) => b.bookID == record.bookID || b.id == record.bookID
        );
        if (book) {
          fetch(`${booksApiUrl}/${book.id}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              AvailableCopies: parseInt(book.AvailableCopies) + 1,
            }),
          });
        }
      })
      .catch((error) => {
        console.error("Error updating record:", error);
        showAlert("Failed to update record", "danger");
      });
  }
}

  function deleteRecord(recordId) {
    if (confirm("Are you sure you want to delete this record?")) {
      fetch(`${borrowRecordsApiUrl}/${recordId}`, {
        method: "DELETE",
      })
        .then((res) => {
          if (!res.ok) throw new Error("Delete failed");
          return fetchBorrowRecords();
        })
        .then(() => {
          renderIssuedBooks();
          showAlert("Record deleted successfully", "success");
        })
        .catch((error) => {
          console.error("Error deleting record:", error);
          showAlert("Failed to delete record", "danger");
        });
    }
  }

  function showAlert(message, type) {
    const existingAlert = document.querySelector(".alert");
    if (existingAlert) existingAlert.remove();

    const alertDiv = document.createElement("div");
    alertDiv.className = `alert alert-${type} alert-dismissible fade show fixed-top mx-auto mt-3`;
    alertDiv.style.maxWidth = "500px";
    alertDiv.style.zIndex = "1100";
    alertDiv.role = "alert";
    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;

    document.body.appendChild(alertDiv);
  }
</script>
