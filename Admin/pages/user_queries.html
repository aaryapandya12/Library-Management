<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
      <i class="fas fa-question-circle me-2"></i> User Queries
    </h2>
    <div class="d-flex">
      <div class="dropdown me-2">
        <ul class="dropdown-menu">
          <li>
            <a class="dropdown-item" href="#" onclick="filterQueries('all')"
              >All Queries</a
            >
          </li>
          <li>
            <a class="dropdown-item" href="#" onclick="filterQueries('Pending')"
              >Pending</a
            >
          </li>
          <li>
            <a
              class="dropdown-item"
              href="#"
              onclick="filterQueries('Resolved')"
              >Resolved</a
            >
          </li>
          <li>
            <a
              class="dropdown-item"
              href="#"
              onclick="filterQueries('High Priority')"
              >High Priority</a
            >
          </li>
        </ul>
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th width="5%">ID</th>
              <th width="20%">User</th>
              <th width="25%">Subject</th>
              <th width="20%">Date</th>
              <th width="15%">Status</th>
              <th width="15%">Actions</th>
            </tr>
          </thead>
          <tbody id="queriesTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="queryDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Query Details</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="mb-4">
          <h6>Subject</h6>
          <p class="fw-bold" id="querySubject"></p>
        </div>

        <div class="mb-4">
          <h6>Message</h6>
          <div class="card bg-light p-3" id="queryMessage"></div>
        </div>

        <div class="mb-3">
          <h6>Admin Response</h6>
          <textarea
            class="form-control"
            rows="4"
            id="adminResponseTextarea"
            placeholder="Type your response here..."
          ></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
        <button
          type="button"
          class="btn btn-success"
          onclick="markAsResolved()"
        >
          Mark as Resolved
        </button>
        <button type="button" class="btn btn-primary" onclick="sendResponse()">
          Send Response
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  function fetchQueries() {
    fetch("http://localhost:8080/api/queries")
      .then((response) => response.json())
      .then((queries) => {
        fetch("http://localhost:8080/api/users")
          .then((response) => response.json())
          .then((users) => {
            const userUsers = users.filter((user) => user.userType === "user");

            const userQueries = queries.filter((query) =>
              userUsers.some((user) => user.userID == query.userID)
            );
            displayQueries(userQueries, userUsers);
          })
          .catch((error) => {
            console.error("Error fetching users:", error);
          });
      })
      .catch((error) => {
        console.error("Error fetching queries:", error);
      });
  }

  function displayQueries(queries, users) {
    const tableBody = document.getElementById("queriesTableBody");
    tableBody.innerHTML = "";

    queries.forEach((query) => {
      const user = users.find((u) => u.userID == query.userID) || {
        Name: "Unknown User",
        Email: "",
      };

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${query.queryID}</td>
        <td>
          <div class="d-flex align-items-center">
            <span>${user.name}</span>
          </div>
        </td>
        <td>${query.subject}</td>
        <td>${query.date}</td>
        <td><span class="badge ${getStatusBadgeClass(query.status)}">${
        query.status
      }</span></td>
        <td>
          <button
            class="btn btn-sm btn-outline-primary me-1"
            data-bs-toggle="modal"
            data-bs-target="#queryDetailModal"
            onclick="showQueryDetails('${query.queryID}')"
          >
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn btn-sm btn-outline-success" onclick="resolveQuery('${
            query.queryID
          }')">
            <i class="fas fa-check"></i>
          </button>
        </td>
      `;
      tableBody.appendChild(row);
    });
  }

  function getStatusBadgeClass(status) {
    switch (status) {
      case "Pending":
        return "bg-warning text-dark";
      case "Resolved":
        return "bg-success";
      case "High Priority":
        return "bg-danger";
      default:
        return "bg-secondary";
    }
  }

  function showQueryDetails(queryId) {
    fetch(`http://localhost:8080/api/queries/${queryId}`)
      .then((response) => response.json())
      .then((query) => {
        document.getElementById("querySubject").textContent = query.subject;
        document.getElementById("queryMessage").innerHTML =
          query.message.replace(/\n/g, "<br>");
        document.getElementById("adminResponseTextarea").value =
          query.adminResponse;
        document
          .getElementById("adminResponseTextarea")
          .setAttribute("data-query-id", queryId);
      })
      .catch((error) => {
        console.error("Error fetching query details:", error);
      });
  }

  fetchQueries();
</script>

<style>
  .table-hover tbody tr:hover {
    background-color: rgba(13, 110, 253, 0.05);
    cursor: pointer;
  }
  .badge {
    font-size: 0.85em;
    font-weight: 500;
    padding: 0.35em 0.65em;
  }
</style>
