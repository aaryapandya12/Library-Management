<div class="card mt-4">
  <div class="card-header bg-#333 text-black">
    <h4 class="mb-0"><i class="bi bi-people me-2"></i>Registered Members</h4>
  </div>
  <div class="card-body">
    <div class="d-flex justify-content-between mb-4">
      <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addMemberModal">
        <i class="fa fa-plus me-2"></i>Add New Member
      </button>
      <div class="input-group" style="width: 300px">
        <input
          type="text"
          class="form-control"
          id="searchInput"
          placeholder="Search members..."
        />
        <button class="btn btn-outline-secondary" type="button">
          <i class="fa fa-search"></i>
        </button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th>User ID</th>
            <th class="sortable">Name <i class="fa fa-sort ms-1"></i></th>
            <th>Email</th>
            <th>Phone</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="membersTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Add Member Modal -->
<div class="modal fade" id="addMemberModal" tabindex="-1" aria-labelledby="addMemberModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="addMemberModalLabel">Add New Member</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="memberForm">
          <div class="mb-3">
            <label for="memberName" class="form-label">Name</label>
            <input
              type="text"
              class="form-control"
              id="memberName"
              required
              minlength="2"
              placeholder="Enter full name"
            />
            <div class="invalid-feedback">
              At least 2 characters required.
            </div>
          </div>
          <div class="mb-3">
            <label for="memberEmail" class="form-label">Email</label>
            <input
              type="email"
              class="form-control"
              id="memberEmail"
              required
              placeholder="Enter email address"
            />
            <div class="invalid-feedback">
              Please enter a valid email.
            </div>
          </div>
          <div class="mb-3">
            <label for="memberPhone" class="form-label">Phone</label>
            <input
              type="tel"
              class="form-control"
              id="memberPhone"
              required
              minlength="10"
              maxlength="15"
              placeholder="Enter phone number"
            />
            <div class="invalid-feedback">
              Please enter a valid phone number (10-15 digits).
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="submitMemberBtn">
          <i class="fa fa-plus me-2"></i>Add Member
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  const usersApiUrl = "http://localhost:3000/users";
  let allUsers = [];
  let editId = null;
  let sortDirection = 1;

  const memberForm = document.getElementById("memberForm");
  const memberName = document.getElementById("memberName");
  const memberEmail = document.getElementById("memberEmail");
  const memberPhone = document.getElementById("memberPhone");
  const submitMemberBtn = document.getElementById("submitMemberBtn");
  const searchInput = document.getElementById("searchInput");
  const membersTableBody = document.getElementById("membersTableBody");
  const sortableHeader = document.querySelector(".sortable");

  fetchUsers().then(() => {
    renderMembers(allUsers);
    setupEventListeners();
  });

  function fetchUsers() {
    return fetch(usersApiUrl)
      .then((res) => {
        if (!res.ok) throw new Error("Failed to fetch users");
        return res.json();
      })
      .then((data) => {
        allUsers = Array.isArray(data) ? data.filter(user => user.UserType === "user") : [];
      })
      .catch((error) => {
        console.error("Error fetching users:", error);
        showAlert("Failed to load users. Please try again.", "danger");
      });
  }

  function setupEventListeners() {
    submitMemberBtn.addEventListener("click", handleMemberSubmit);

    searchInput.addEventListener("input", () => {
      const searchTerm = searchInput.value.toLowerCase();
      const filtered = allUsers.filter(
        (user) =>
          (user.Name && user.Name.toLowerCase().includes(searchTerm)) ||
          (user.Email && user.Email.toLowerCase().includes(searchTerm)) ||
          (user.Phone && user.Phone.includes(searchTerm)) ||
          (user.Mobile && user.Mobile.includes(searchTerm))
      );
      renderMembers(filtered);
    });

    [memberName, memberEmail, memberPhone].forEach((input) => {
      input.addEventListener("blur", () => validateMemberField(input));
    });

    sortableHeader?.addEventListener("click", () => {
      const sorted = [...allUsers].sort(
        (a, b) => (a.Name || "").localeCompare(b.Name || "") * sortDirection
      );
      sortDirection *= -1;
      renderMembers(sorted);
    });
  }

  function validateMemberField(input) {
    let isValid = true;
    
    if (input.id === "memberEmail") {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      isValid = emailRegex.test(input.value.trim());
    } else if (input.id === "memberPhone") {
      const phoneRegex = /^[0-9]{10,15}$/;
      isValid = phoneRegex.test(input.value.trim());
    } else {
      isValid = input.value.trim().length >= (input.minLength || 2);
    }

    input.classList.toggle("is-invalid", !isValid);
    input.classList.toggle("is-valid", isValid);
    return isValid;
  }

  function validateMemberForm() {
    let isValid = true;

    [memberName, memberEmail, memberPhone].forEach((field) => {
      if (!validateMemberField(field)) {
        isValid = false;
      }
    });

    return isValid;
  }

  function clearMemberValidation() {
    [memberName, memberEmail, memberPhone].forEach((field) => {
      field.classList.remove("is-invalid", "is-valid");
    });
  }

  function renderMembers(users) {
    membersTableBody.innerHTML = users
      .map(
        (user) => `
      <tr>
        <td>${user.UserID || "N/A"}</td>
        <td>${user.Name || "N/A"}</td>
        <td>${user.Email || "N/A"}</td>
        <td>${user.Phone || user.Mobile || "N/A"}</td>
        <td>
          <button class="btn btn-sm btn-primary me-1 edit-btn" data-id="${user.id}">
            <i class="fa fa-edit"></i>
          </button>
          <button class="btn btn-sm btn-danger delete-btn" data-id="${user.id}">
            <i class="fa fa-trash"></i>
          </button>
        </td>
      </tr>
    `
      )
      .join("");

    document.querySelectorAll(".edit-btn").forEach((btn) => {
      btn.addEventListener("click", () => loadMemberForEdit(btn.dataset.id));
    });

    document.querySelectorAll(".delete-btn").forEach((btn) => {
      btn.addEventListener("click", () => deleteMember(btn.dataset.id));
    });
  }

  function loadMemberForEdit(id) {
    const user = allUsers.find((u) => u.id === id);
    if (user) {
      memberName.value = user.Name || "";
      memberEmail.value = user.Email || "";
      memberPhone.value = user.Phone || user.Mobile || "";

      submitMemberBtn.innerHTML = `<i class="fa fa-edit me-2"></i>Update Member`;
      editId = id;

      const modal = new bootstrap.Modal(document.getElementById("addMemberModal"));
      modal.show();
    }
  }

  function deleteMember(id) {
    if (confirm("Are you sure you want to delete this member?")) {
      fetch(`${usersApiUrl}/${id}`, {
        method: "DELETE",
      })
        .then((res) => {
          if (!res.ok) throw new Error("Delete failed");
          return fetchUsers();
        })
        .then(() => {
          renderMembers(allUsers);
          showAlert("Member deleted successfully", "success");
        })
        .catch((error) => {
          console.error("Error deleting member:", error);
          showAlert("Failed to delete member", "danger");
        });
    }
  }

  function handleMemberSubmit(e) {
    e.preventDefault();
    if (!validateMemberForm()) return;

    const memberData = {
      Name: memberName.value.trim(),
      Email: memberEmail.value.trim(),
      Phone: memberPhone.value.trim(),
      UserType: "user",
      UserID: editId
        ? allUsers.find((u) => u.id === editId).UserID
        : generateUserId(),
    };

    const method = editId ? "PUT" : "POST";
    const url = editId ? `${usersApiUrl}/${editId}` : usersApiUrl;

    fetch(url, {
      method: method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(memberData),
    })
      .then((res) => {
        if (!res.ok) throw new Error(`${method} request failed`);
        return fetchUsers();
      })
      .then(() => {
        memberForm.reset();
        clearMemberValidation();
        editId = null;
        submitMemberBtn.innerHTML = `<i class="fa fa-plus me-2"></i>Add Member`;
        renderMembers(allUsers);
        showAlert(`Member ${method === "PUT" ? "updated" : "added"} successfully`, "success");

        const modal = bootstrap.Modal.getInstance(document.getElementById("addMemberModal"));
        modal.hide();
      })
      .catch((error) => {
        console.error(`Error ${method === "PUT" ? "updating" : "creating"} member:`, error);
        showAlert(`Failed to ${method === "PUT" ? "update" : "add"} member`, "danger");
      });
  }

  function generateUserId() {
    return Math.max(...allUsers.map((u) => u.UserID || 0), 0) + 1;
  }

  function showAlert(message, type) {
    const existingAlert = document.querySelector(".alert");
    if (existingAlert) existingAlert.remove();

    const alertDiv = document.createElement("div");
    alertDiv.className = `alert alert-${type} alert-dismissible fade show fixed-top mx-auto mt-3`;
    alertDiv.style.maxWidth = "500px";
    alertDiv.style.zIndex = "1100";
    alertDiv.role = "alert";
    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;

    document.body.appendChild(alertDiv);
  }
</script>