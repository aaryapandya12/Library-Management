<div class="card mt-4">
  <div class="card-header bg-#333 text-black">
    <h4 class="mb-0"><i class="bi bi-person-plus me-2"></i>Author Master</h4>
  </div>
  <div class="card-body">
    <div class="d-flex justify-content-between mb-4">
      <button
        class="btn btn-success"
        data-bs-toggle="modal"
        data-bs-target="#authorModal"
      >
        <i class="bi bi-plus-circle me-2"></i>Add New Author
      </button>
      <div class="input-group" style="width: 300px">
        <span class="input-group-text bg-light"
          ><i class="bi bi-search"></i
        ></span>
        <input
          type="text"
          id="searchInput"
          class="form-control shadow-sm"
          placeholder="Search by Author Name..."
        />
      </div>
    </div>

    <div class="table-responsive rounded-3 border">
      <table class="table table-striped table-hover mb-0">
        <thead class="table-dark">
          <tr>
            <th class="ps-4">Author ID</th>
            <th class="sortable">
              Name <i class="bi bi-arrow-down-up ms-1"></i>
            </th>
            <th>Bio</th>
            <th class="pe-4 text-end">Actions</th>
          </tr>
        </thead>
        <tbody id="adminBodyTable" class="border-top-0"></tbody>
      </table>
    </div>
  </div>
</div>

<div
  class="modal fade"
  id="authorModal"
  tabindex="-1"
  aria-labelledby="authorModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="authorModalLabel">Add New Author</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="authorForm">
          <div class="mb-3">
            <label for="names" class="form-label fw-bold">Author Name</label>
            <input
              type="text"
              class="form-control shadow-sm"
              id="names"
              placeholder="Enter Author Name"
              required
              minlength="5"
            />
            <div class="invalid-feedback">At least 5 characters required.</div>
          </div>
          <div class="mb-3">
            <label for="bio" class="form-label fw-bold">Author Bio</label>
            <input
              type="text"
              class="form-control shadow-sm"
              id="bio"
              placeholder="Enter Bio"
              required
              minlength="5"
            />
            <div class="invalid-feedback">At least 15 characters required.</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" id="submitBtn">
          <i class="bi bi-plus-circle me-2"></i>Add Author
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  const apiUrl = "http://localhost:3000/authors";
  let allAuthors = [];
  let editId = null;
  let sortDirection = 1;

  const names = document.getElementById("names");
  const bio = document.getElementById("bio");
  const submitBtn = document.getElementById("submitBtn");
  const form = document.getElementById("authorForm");
  const searchInput = document.getElementById("searchInput");
  const tableBody = document.getElementById("adminBodyTable");
  const sortableHeader = document.querySelector(".sortable");
  const authorModal = new bootstrap.Modal(
    document.getElementById("authorModal")
  );

  fetchAndRenderAuthors();
  setupEventListeners();

  function setupEventListeners() {
    submitBtn.addEventListener("click", handleFormSubmit);

    searchInput.addEventListener("input", () => {
      const searchTerm = searchInput.value.toLowerCase();
      const filtered = allAuthors.filter((author) =>
        author.AuthorName.toLowerCase().includes(searchTerm)
      );
      renderAuthors(filtered);
    });

    [names, bio].forEach((input) => {
      input.addEventListener("blur", () => {
        validateField(input);
      });
    });

    sortableHeader.addEventListener("click", () => {
      const sorted = [...allAuthors].sort(
        (a, b) => a.AuthorName.localeCompare(b.AuthorName) * sortDirection
      );
      sortDirection *= -1;
      renderAuthors(sorted);
    });
  }

  function validateField(input) {
    if (input.value.trim().length < 5) {
      input.classList.add("is-invalid");
      input.classList.remove("is-valid");
      return false;
    } else {
      input.classList.remove("is-invalid");
      input.classList.add("is-valid");
      return true;
    }
  }

  function validateForm() {
    let isValid = true;
    [names, bio].forEach((input) => {
      if (input.value.trim().length < 5) {
        input.classList.add("is-invalid");
        isValid = false;
      } else {
        input.classList.remove("is-invalid");
      }
    });
    return isValid;
  }

  function clearValidation() {
    [names, bio].forEach((input) => {
      input.classList.remove("is-invalid", "is-valid");
    });
  }

  function fetchAndRenderAuthors() {
    fetch(apiUrl)
      .then((res) => {
        if (!res.ok) throw new Error("Network response was not ok");
        return res.json();
      })
      .then((data) => {
        allAuthors = Array.isArray(data) ? data : [];
        renderAuthors(allAuthors);
      })
      .catch((error) => {
        console.error("Error fetching authors:", error);
      });
  }

  function renderAuthors(authors) {
    tableBody.innerHTML = authors
      .map(
        (author) => `
      <tr>
        <td class="ps-4">${author.id}</td>
        <td>${author.AuthorName}</td>
        <td>${author.Bio}</td>
        <td class="pe-4 text-end">
          <button class="btn btn-sm btn-outline-primary me-2 edit-btn" data-id="${author.id}">
            <i class="bi bi-pencil-square me-1"></i>Edit
          </button>
          <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${author.id}">
            <i class="bi bi-trash me-1"></i>Delete
          </button>
        </td>
      </tr>
    `
      )
      .join("");

    document.querySelectorAll(".edit-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-id");
        loadAuthorForEdit(id);
      });
    });

    document.querySelectorAll(".delete-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-id");
        deleteAuthor(id);
      });
    });
  }

  function loadAuthorForEdit(id) {
    fetch(`${apiUrl}/${id}`)
      .then((res) => {
        if (!res.ok) throw new Error("Network response was not ok");
        return res.json();
      })
      .then((data) => {
        names.value = data.AuthorName;
        bio.value = data.Bio;
        editId = id;
        submitBtn.innerHTML = `<i class="bi bi-pencil-square me-2"></i>Update Author`;
        document.getElementById("authorModalLabel").textContent = "Edit Author";
        authorModal.show();
      })
      .catch((error) => {
        console.error("Error loading author:", error);
      });
  }

  function deleteAuthor(id) {
    if (confirm("Are you sure you want to delete this author?")) {
      fetch(`${apiUrl}/${id}`, {
        method: "DELETE",
      })
        .then((res) => {
          if (!res.ok) throw new Error("Delete failed");
          fetchAndRenderAuthors();
        })
        .catch((error) => {
          console.error("Error deleting author:", error);
        });
    }
  }

  function handleFormSubmit(e) {
    e.preventDefault();
    if (!validateForm()) return;

    const author = {
      AuthorName: names.value.trim(),
      Bio: bio.value.trim(),
    };

    const method = editId ? "PUT" : "POST";
    const url = editId ? `${apiUrl}/${editId}` : apiUrl;

    fetch(url, {
      method: method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(author),
    })
      .then((res) => {
        if (!res.ok) throw new Error(`${method} request failed`);
        return fetchAndRenderAuthors();
      })
      .then(() => {
        form.reset();
        clearValidation();
        editId = null;
        submitBtn.innerHTML = `<i class="bi bi-plus-circle me-2"></i>Add Author`;
        document.getElementById("authorModalLabel").textContent =
          "Add New Author";
        authorModal.hide();
      })
      .catch((error) => {
        console.error(
          `Error ${method === "PUT" ? "updating" : "creating"} author:`,
          error
        );
      });
  }
</script>
